<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Личный кабинет — Скринер</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .shadow-brutal { box-shadow: 4px 4px 0px 0px rgba(0,0,0,1); }
    .shadow-brutal-lg { box-shadow: 6px 6px 0px 0px rgba(0,0,0,1); }
    .shadow-brutal-sm { box-shadow: 3px 3px 0px 0px rgba(0,0,0,1); }
    .hover-press:hover { transform: translate(2px, 2px); box-shadow: none; }
    .hover-press-sm:hover { transform: translate(1px, 1px); box-shadow: none; }
  </style>
</head>
<body class="bg-[#FFFEF9] text-black">
  <nav class="py-4 px-6 md:px-12 flex justify-between items-center">
    <div class="flex items-center gap-2">
      <div class="w-10 h-10 bg-[#FCD34D] border-2 border-black rounded-xl shadow-brutal-sm flex items-center justify-center font-black text-lg">
        С
      </div>
      <span class="font-bold text-xl">скринер</span>
    </div>
    <div class="flex items-center gap-3">
      <a href="/index.html" class="bg-white border-2 border-black rounded-xl px-4 py-2 font-semibold shadow-brutal-sm hover-press-sm transition-all">
        Матчер
      </a>
      <a href="https://s.analystexe.ru" class="bg-white border-2 border-black rounded-xl px-4 py-2 font-semibold shadow-brutal-sm hover-press-sm transition-all">
        На главную
      </a>
    </div>
  </nav>

  <section class="px-6 md:px-12 py-10">
    <div class="max-w-4xl mx-auto">
      <div class="inline-block bg-[#FCD34D] border-2 border-black rounded-full px-4 py-1 mb-6 shadow-brutal-sm font-medium text-sm">
        Личный кабинет
      </div>
      <h1 class="text-3xl md:text-5xl font-black mb-4">История проверок</h1>
      <p class="text-gray-700 text-lg mb-8">Вход через Telegram. После входа увидишь все свои запросы.</p>

      <div id="login-section" class="bg-white border-2 border-black rounded-2xl p-6 shadow-brutal mb-8">
        <div class="font-bold text-xl mb-2">Войти через Telegram</div>
        <p class="text-gray-600 mb-4">Нажми кнопку, открой Telegram и подтвердить вход.</p>
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
          <button id="login-btn" class="bg-black text-white border-2 border-black rounded-2xl px-6 py-3 font-bold shadow-brutal hover-press transition-all">
            Открыть Telegram
          </button>
          <a id="tg-link" href="#" target="_blank" class="hidden text-sm underline">Открыть ссылку вручную</a>
        </div>
        <div id="login-status" class="mt-4 text-sm text-gray-600"></div>
      </div>

      <div id="user-section" class="hidden bg-white border-2 border-black rounded-2xl p-6 shadow-brutal mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <div class="text-sm text-gray-500">Ты вошел как</div>
            <div id="user-info" class="text-xl font-bold"></div>
            <div id="admin-badge" class="hidden mt-2 inline-flex items-center gap-2 bg-[#FCD34D] border-2 border-black rounded-full px-3 py-1 text-xs font-bold">Админ</div>
          </div>
          <button id="logout-btn" class="bg-white border-2 border-black rounded-2xl px-4 py-2 font-semibold shadow-brutal-sm hover-press-sm transition-all">
            Выйти
          </button>
        </div>
      </div>

      <div id="history-section" class="hidden">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
          <h2 class="text-2xl font-black">Мои запросы</h2>
          <button id="load-more-btn" class="bg-white border-2 border-black rounded-2xl px-4 py-2 font-semibold shadow-brutal-sm hover-press-sm transition-all">
            Показать еще
          </button>
        </div>
        <div id="history-list" class="space-y-4"></div>
      </div>

      <div id="admin-section" class="hidden mt-12">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
          <h2 class="text-2xl font-black">Админ: все запросы</h2>
          <div class="flex flex-col sm:flex-row gap-3">
            <input id="admin-user-filter" class="border-2 border-black rounded-xl px-3 py-2 text-sm" placeholder="user_id (опционально)">
            <button id="admin-load-btn" class="bg-black text-white border-2 border-black rounded-2xl px-4 py-2 font-semibold shadow-brutal hover-press transition-all">
              Загрузить
            </button>
          </div>
        </div>
        <div id="admin-history-list" class="space-y-4"></div>
      </div>
    </div>
  </section>

  <script>
    const tokenKey = 'screener_session_token';
    let loginState = null;
    let historyOffset = 0;
    const historyLimit = 10;

    const loginSection = document.getElementById('login-section');
    const userSection = document.getElementById('user-section');
    const historySection = document.getElementById('history-section');
    const adminSection = document.getElementById('admin-section');

    const loginStatus = document.getElementById('login-status');
    const loginBtn = document.getElementById('login-btn');
    const tgLink = document.getElementById('tg-link');
    const userInfo = document.getElementById('user-info');
    const adminBadge = document.getElementById('admin-badge');
    const logoutBtn = document.getElementById('logout-btn');
    const historyList = document.getElementById('history-list');
    const loadMoreBtn = document.getElementById('load-more-btn');
    const adminLoadBtn = document.getElementById('admin-load-btn');
    const adminHistoryList = document.getElementById('admin-history-list');
    const adminUserFilter = document.getElementById('admin-user-filter');

    function escapeHtml(text) {
      return (text || '').replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[ch]));
    }

    function getCookie(name) {
      const match = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]*)`));
      return match ? decodeURIComponent(match[1]) : '';
    }

    function setToken(token) {
      localStorage.setItem(tokenKey, token);
      const secure = window.location.protocol === 'https:' ? '; Secure' : '';
      document.cookie = `screener_session=${token}; Path=/; Max-Age=86400; SameSite=Lax${secure}`;
    }

    function getToken() {
      const stored = localStorage.getItem(tokenKey);
      if (stored) return stored;
      const cookieToken = getCookie('screener_session');
      if (cookieToken) {
        localStorage.setItem(tokenKey, cookieToken);
        return cookieToken;
      }
      return '';
    }

    function clearToken() {
      localStorage.removeItem(tokenKey);
      document.cookie = 'screener_session=; Path=/; Max-Age=0; SameSite=Lax';
    }

    function authHeaders() {
      const token = getToken();
      return token ? { 'Authorization': `Bearer ${token}` } : {};
    }

    async function fetchMe() {
      const resp = await fetch('/api/me', { headers: authHeaders(), credentials: 'same-origin' });
      if (!resp.ok) return null;
      return resp.json();
    }

    function renderItems(items, target, showUser) {
      if (!items || items.length === 0) {
        target.innerHTML = '<div class="text-sm text-gray-600">Пока пусто.</div>';
        return;
      }
      target.innerHTML = items.map((item) => {
        const statusLabel = item.status === 'ok' ? 'Успешно' : 'Ошибка';
        const statusClass = item.status === 'ok' ? 'bg-[#DCFCE7]' : 'bg-[#FEE2E2]';
        const userLine = showUser
          ? `<div class="text-xs text-gray-500">user_id: ${escapeHtml(item.user_id || '')} · ${escapeHtml(item.username || '')}</div>`
          : '';
        const summary = item.result && item.result.summary ? escapeHtml(item.result.summary) : '';
        const error = item.error ? `<div class="text-sm text-red-700">${escapeHtml(item.error)}</div>` : '';
        return `
          <div class="bg-white border-2 border-black rounded-2xl p-5 shadow-brutal">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div>
                <div class="text-sm text-gray-500">${escapeHtml(item.created_at || '')}</div>
                <div class="text-sm text-gray-500">request_id: ${escapeHtml(item.request_id || '')}</div>
                ${userLine}
              </div>
              <div class="${statusClass} border-2 border-black rounded-full px-3 py-1 text-xs font-bold">${statusLabel}</div>
            </div>
            ${summary ? `<div class="mt-3 text-sm">${summary}</div>` : ''}
            ${error ? `<div class="mt-3">${error}</div>` : ''}
            <div class="mt-4 grid gap-3">
              <details class="bg-[#FFFEF9] border-2 border-black rounded-xl p-3">
                <summary class="font-semibold cursor-pointer">Текст вакансии</summary>
                <pre class="text-xs whitespace-pre-wrap mt-2">${escapeHtml(item.vacancy_text || '')}</pre>
              </details>
              <details class="bg-[#FFFEF9] border-2 border-black rounded-xl p-3">
                <summary class="font-semibold cursor-pointer">Текст резюме</summary>
                <pre class="text-xs whitespace-pre-wrap mt-2">${escapeHtml(item.resume_text || '')}</pre>
              </details>
              ${item.result ? `
                <details class="bg-[#FFFEF9] border-2 border-black rounded-xl p-3">
                  <summary class="font-semibold cursor-pointer">Результат</summary>
                  <pre class="text-xs whitespace-pre-wrap mt-2">${escapeHtml(JSON.stringify(item.result, null, 2))}</pre>
                </details>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadHistory(reset = false) {
      if (reset) {
        historyOffset = 0;
        historyList.innerHTML = '';
      }
      const resp = await fetch(`/api/history?limit=${historyLimit}&offset=${historyOffset}`, { headers: authHeaders(), credentials: 'same-origin' });
      if (!resp.ok) return;
      const data = await resp.json();
      if (!data.ok) return;
      if (historyOffset === 0) {
        renderItems(data.items, historyList, false);
      } else if (data.items && data.items.length) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = data.items.map((item) => {
          const statusLabel = item.status === 'ok' ? 'Успешно' : 'Ошибка';
          const statusClass = item.status === 'ok' ? 'bg-[#DCFCE7]' : 'bg-[#FEE2E2]';
          const summary = item.result && item.result.summary ? escapeHtml(item.result.summary) : '';
          const error = item.error ? `<div class="text-sm text-red-700">${escapeHtml(item.error)}</div>` : '';
          return `
            <div class="bg-white border-2 border-black rounded-2xl p-5 shadow-brutal mt-4">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div>
                  <div class="text-sm text-gray-500">${escapeHtml(item.created_at || '')}</div>
                  <div class="text-sm text-gray-500">request_id: ${escapeHtml(item.request_id || '')}</div>
                </div>
                <div class="${statusClass} border-2 border-black rounded-full px-3 py-1 text-xs font-bold">${statusLabel}</div>
              </div>
              ${summary ? `<div class="mt-3 text-sm">${summary}</div>` : ''}
              ${error ? `<div class="mt-3">${error}</div>` : ''}
              <div class="mt-4 grid gap-3">
                <details class="bg-[#FFFEF9] border-2 border-black rounded-xl p-3">
                  <summary class="font-semibold cursor-pointer">Текст вакансии</summary>
                  <pre class="text-xs whitespace-pre-wrap mt-2">${escapeHtml(item.vacancy_text || '')}</pre>
                </details>
                <details class="bg-[#FFFEF9] border-2 border-black rounded-xl p-3">
                  <summary class="font-semibold cursor-pointer">Текст резюме</summary>
                  <pre class="text-xs whitespace-pre-wrap mt-2">${escapeHtml(item.resume_text || '')}</pre>
                </details>
                ${item.result ? `
                  <details class="bg-[#FFFEF9] border-2 border-black rounded-xl p-3">
                    <summary class="font-semibold cursor-pointer">Результат</summary>
                    <pre class="text-xs whitespace-pre-wrap mt-2">${escapeHtml(JSON.stringify(item.result, null, 2))}</pre>
                  </details>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
        historyList.appendChild(wrapper);
      }
      historyOffset += data.items.length;
    }

    async function loadAdminHistory() {
      const userId = adminUserFilter.value.trim();
      const query = userId ? `user_id=${encodeURIComponent(userId)}&limit=20&offset=0` : 'limit=20&offset=0';
      const resp = await fetch(`/api/admin/history?${query}`, { headers: authHeaders(), credentials: 'same-origin' });
      if (!resp.ok) return;
      const data = await resp.json();
      if (!data.ok) return;
      renderItems(data.items, adminHistoryList, true);
    }

    async function startLogin() {
      loginStatus.textContent = 'Запрашиваем ссылку...';
      const resp = await fetch('/api/tg/login/start', { method: 'POST' });
      const data = await resp.json();
      if (!data.ok) {
        loginStatus.textContent = 'Ошибка: ' + (data.error || 'unknown');
        return;
      }
      loginState = data.state;
      tgLink.href = data.tg_url;
      tgLink.classList.remove('hidden');
      loginStatus.textContent = 'Открой Telegram и нажми Start. Ждем подтверждения...';
      window.open(data.tg_url, '_blank');
      pollLogin();
    }

    async function pollLogin() {
      if (!loginState) return;
      const resp = await fetch(`/api/tg/login/status?state=${encodeURIComponent(loginState)}`);
      const data = await resp.json();
      if (data.ok && data.token) {
        setToken(data.token);
        loginState = null;
        loginStatus.textContent = 'Вход подтвержден.';
        await boot();
        return;
      }
      setTimeout(pollLogin, 1500);
    }

    async function boot() {
      const token = getToken();
      if (token) setToken(token);
      const me = await fetchMe();
      if (!me || !me.ok) {
        loginSection.classList.remove('hidden');
        userSection.classList.add('hidden');
        historySection.classList.add('hidden');
        adminSection.classList.add('hidden');
        return;
      }
      loginSection.classList.add('hidden');
      userSection.classList.remove('hidden');
      historySection.classList.remove('hidden');
      userInfo.textContent = `${me.user.first_name || ''} ${me.user.last_name || ''} @${me.user.username || 'user'} (id ${me.user.id})`;
      if (me.is_admin) {
        adminBadge.classList.remove('hidden');
        adminSection.classList.remove('hidden');
        if (window.location.hash === '#admin') {
          adminSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      } else {
        adminBadge.classList.add('hidden');
        adminSection.classList.add('hidden');
      }
      await loadHistory(true);
    }

    loginBtn.addEventListener('click', startLogin);
    loadMoreBtn.addEventListener('click', () => loadHistory());
    adminLoadBtn.addEventListener('click', loadAdminHistory);
    logoutBtn.addEventListener('click', () => {
      clearToken();
      boot();
    });

    boot();
  </script>
</body>
</html>
