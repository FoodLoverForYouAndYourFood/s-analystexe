<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ç—á–µ—Ä ‚Äî –°—Ä–∞–≤–Ω–∏ —Ä–µ–∑—é–º–µ —Å –≤–∞–∫–∞–Ω—Å–∏–µ–π</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .shadow-brutal { box-shadow: 4px 4px 0px 0px rgba(0,0,0,1); }
        .shadow-brutal-lg { box-shadow: 6px 6px 0px 0px rgba(0,0,0,1); }
        .shadow-brutal-sm { box-shadow: 3px 3px 0px 0px rgba(0,0,0,1); }
        .hover-press:hover:not(:disabled) { transform: translate(2px, 2px); box-shadow: none; }
        .hover-press-sm:hover { transform: translate(1px, 1px); box-shadow: none; }
        textarea:focus { outline: none; box-shadow: 0 0 0 3px #FCD34D; }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-[#FFFEF9] text-black min-h-screen">

    <!-- Navigation -->
    <nav class="py-4 px-6 md:px-12 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 bg-[#FCD34D] border-2 border-black rounded-xl shadow-brutal-sm flex items-center justify-center font-black text-lg">
                –ú
            </div>
            <span class="font-bold text-xl">–º–∞—Ç—á–µ—Ä</span>
        </div>
        <div class="flex items-center gap-3">
            <a id="login-link" href="/cabinet.html" class="bg-white border-2 border-black rounded-xl px-4 py-2 font-semibold shadow-brutal-sm hover-press-sm transition-all cursor-pointer text-sm">
                –í–æ–π—Ç–∏
            </a>
            <a id="cabinet-link" href="/cabinet.html" class="hidden bg-[#FCD34D] border-2 border-black rounded-xl px-4 py-2 font-semibold shadow-brutal-sm hover-press-sm transition-all cursor-pointer text-sm">
                –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
            </a>
            <a id="admin-link" href="/cabinet.html#admin" class="hidden bg-black text-white border-2 border-black rounded-xl px-4 py-2 font-semibold shadow-brutal-sm hover-press-sm transition-all cursor-pointer text-sm">
                –ê–¥–º–∏–Ω
            </a>
            <span id="user-badge" class="hidden border-2 border-black rounded-xl px-3 py-2 text-xs font-semibold shadow-brutal-sm"></span>
            <a href="./index.html" class="bg-white border-2 border-black rounded-xl px-4 py-2 font-semibold shadow-brutal-sm hover-press-sm transition-all cursor-pointer text-sm">
                ‚Üê –ö –°–∫—Ä–∏–Ω–µ—Ä—É
            </a>
        </div>
    </nav>

    <!-- Hero -->
    <section class="px-6 md:px-12 py-8 md:py-12">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-3xl md:text-5xl font-black mb-4 leading-tight">
                —Ä–µ–∑—é–º–µ <span class="bg-[#FCD34D] px-2">vs</span> –≤–∞–∫–∞–Ω—Å–∏—è
            </h1>
            <p class="text-lg text-gray-700 max-w-2xl mx-auto">
                –í—Å—Ç–∞–≤—å –≤–∞–∫–∞–Ω—Å–∏—é –∏ —Ä–µ–∑—é–º–µ ‚Äî AI –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, —á—Ç–æ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å, –∏ –≥–¥–µ gaps.
            </p>
        </div>
    </section>

    <!-- Main Tool -->
    <section class="px-6 md:px-12 pb-16">
        <div class="max-w-6xl mx-auto">
            
            <!-- Input Section -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <!-- Vacancy -->
                <div class="bg-white border-2 border-black rounded-2xl p-6 shadow-brutal">
                    <label class="font-bold text-lg mb-3 block flex items-center gap-2">
                        <span class="w-8 h-8 bg-[#FCD34D] border-2 border-black rounded-lg flex items-center justify-center text-sm">üìã</span>
                        –í–∞–∫–∞–Ω—Å–∏—è
                    </label>
                    <textarea 
                        id="vacancy-input"
                        placeholder="–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏ —Å—é–¥–∞..."
                        class="w-full h-64 border-2 border-black rounded-xl p-4 resize-none text-sm"
                    ></textarea>
                </div>

                <!-- Resume -->
                <div class="bg-white border-2 border-black rounded-2xl p-6 shadow-brutal">
                    <label class="font-bold text-lg mb-3 block flex items-center gap-2">
                        <span class="w-8 h-8 bg-[#FCD34D] border-2 border-black rounded-lg flex items-center justify-center text-sm">üë§</span>
                        –†–µ–∑—é–º–µ
                    </label>
                    <textarea 
                        id="resume-input"
                        placeholder="–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ —Å—é–¥–∞..."
                        class="w-full h-64 border-2 border-black rounded-xl p-4 resize-none text-sm"
                    ></textarea>
                </div>
            </div>

            <!-- Analyze Button -->
            <div class="text-center mb-12">
                <button 
                    id="analyze-btn"
                    onclick="analyzeMatch()"
                    class="bg-[#FCD34D] border-2 border-black rounded-2xl px-12 py-4 font-bold text-xl shadow-brutal hover-press transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    –°—Ä–∞–≤–Ω–∏—Ç—å ‚Üí
                </button>
                <p class="text-sm text-gray-600 mt-3">–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω—É–∂–µ–Ω –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram. –û—Ç–∫—Ä–æ–π ¬´–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç¬ª.</p>
                <p id="error-msg" class="text-red-600 mt-4 hidden"></p>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden">
                
                <!-- Summary Cards -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-green-100 border-2 border-black rounded-2xl p-6 shadow-brutal text-center">
                        <div class="text-4xl font-black text-green-700" id="match-count">0</div>
                        <div class="font-semibold">‚úÖ –°–æ–≤–ø–∞–¥–µ–Ω–∏–π</div>
                    </div>
                    <div class="bg-yellow-100 border-2 border-black rounded-2xl p-6 shadow-brutal text-center">
                        <div class="text-4xl font-black text-yellow-700" id="partial-count">0</div>
                        <div class="font-semibold">üü° –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å</div>
                    </div>
                    <div class="bg-red-100 border-2 border-black rounded-2xl p-6 shadow-brutal text-center">
                        <div class="text-4xl font-black text-red-700" id="gap-count">0</div>
                        <div class="font-semibold">‚ùå Gaps</div>
                    </div>
                </div>

                <!-- Detailed Results -->
                <div class="bg-white border-2 border-black rounded-2xl p-6 md:p-8 shadow-brutal-lg">
                    <h2 class="font-black text-2xl mb-6">–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h2>
                    <div id="analysis-content" class="prose max-w-none">
                        <!-- Content will be inserted here -->
                    </div>
                </div>

            </div>

            <!-- Loading State -->
            <div id="loading-section" class="hidden">
                <div class="bg-white border-2 border-black rounded-2xl p-12 shadow-brutal-lg text-center">
                    <div class="text-6xl mb-4 loading">üîç</div>
                    <div class="font-bold text-xl mb-2">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...</div>
                    <div class="text-gray-600">–°—Ä–∞–≤–Ω–∏–≤–∞—é —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å —Ç–≤–æ–∏–º –æ–ø—ã—Ç–æ–º</div>
                </div>
            </div>

        </div>
    </section>

    <!-- Footer -->
    <footer class="px-6 md:px-12 py-8 border-t-2 border-black">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-[#FCD34D] border-2 border-black rounded-lg flex items-center justify-center font-black text-sm">
                    –ú
                </div>
                <span class="font-bold">–º–∞—Ç—á–µ—Ä</span>
                <span class="text-gray-400 text-sm ml-2">—á–∞—Å—Ç—å —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã —Å–∫—Ä–∏–Ω–µ—Ä</span>
            </div>
            <div class="text-sm text-gray-500">
                ¬© 2025
            </div>
        </div>
    </footer>

    <script>
        const sendEvent = (event) => {
            fetch('/api/event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ event })
            }).catch(() => {});
        };

        document.addEventListener('DOMContentLoaded', () => {
            sendEvent('page_view');
        });

        /*
        =====================================================
        BACKEND TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint POST /api/analyze
        =====================================================
        
        REQUEST:
        {
            "vacancy": "—Ç–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏",
            "resume": "—Ç–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ"
        }
        
        RESPONSE (JSON):
        {
            "requirements": [
                {
                    "requirement": "–ó–Ω–∞–Ω–∏–µ SQL",
                    "status": "match|partial|gap",
                    "found_in_resume": "–ì–¥–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ä–µ–∑—é–º–µ –∏–ª–∏ null",
                    "recommendation": "–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å"
                }
            ],
            "quick_wins": [
                "–ü–µ—Ä–≤–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ",
                "–í—Ç–æ—Ä–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ",
                "–¢—Ä–µ—Ç—å–µ —É–ª—É—á—à–µ–Ω–∏–µ"
            ],
            "summary": "–ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –≤ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"
        }
        
        PROMPT –î–õ–Ø LLM:
        ---
        –¢—ã ‚Äî –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å –æ–ø—ã—Ç–æ–º –Ω–∞–π–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤.
        –ü—Ä–æ–≤–µ–¥–∏ GAP-–∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–∏.

        –û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
        {
            "requirements": [
                {
                    "requirement": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è",
                    "status": "match|partial|gap",
                    "found_in_resume": "–ì–¥–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ null",
                    "recommendation": "–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å"
                }
            ],
            "quick_wins": ["...", "...", "..."],
            "summary": "–ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥"
        }

        status:
        - "match" = –ø–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        - "partial" = –µ—Å—Ç—å –æ–ø—ã—Ç, –Ω–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ –∏–Ω–∞—á–µ  
        - "gap" = –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

        –í–ê–ö–ê–ù–°–ò–Ø:
        {vacancy}

        –†–ï–ó–Æ–ú–ï:
        {resume}
        ---
        
        =====================================================
        */

        function getCookie(name) {
            const match = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]*)`));
            return match ? decodeURIComponent(match[1]) : '';
        }

        function getToken() {
            const stored = localStorage.getItem('screener_session_token');
            if (stored) return stored;
            const cookieToken = getCookie('screener_session');
            if (cookieToken) {
                localStorage.setItem('screener_session_token', cookieToken);
                return cookieToken;
            }
            return '';
        }

        function ensureCookie(token) {
            if (!token) return;
            const secure = window.location.protocol === 'https:' ? '; Secure' : '';
            document.cookie = `screener_session=${token}; Path=/; Max-Age=86400; SameSite=Lax${secure}`;
        }

        function updateAuthUI(user, isAdmin) {
            const loginLink = document.getElementById('login-link');
            const cabinetLink = document.getElementById('cabinet-link');
            const adminLink = document.getElementById('admin-link');
            const userBadge = document.getElementById('user-badge');
            if (!user) {
                loginLink.classList.remove('hidden');
                cabinetLink.classList.add('hidden');
                adminLink.classList.add('hidden');
                userBadge.classList.add('hidden');
                return;
            }
            loginLink.classList.add('hidden');
            cabinetLink.classList.remove('hidden');
            userBadge.textContent = `@${user.username || user.first_name || 'user'}`;
            userBadge.classList.remove('hidden');
            if (isAdmin) {
                adminLink.classList.remove('hidden');
            } else {
                adminLink.classList.add('hidden');
            }
        }

        async function bootAuth() {
            const token = getToken();
            if (!token) {
                updateAuthUI(null, false);
                return;
            }
            ensureCookie(token);
            try {
                const resp = await fetch('/api/me', {
                    headers: { Authorization: `Bearer ${token}` },
                    credentials: 'same-origin'
                });
                if (!resp.ok) {
                    localStorage.removeItem('screener_session_token');
                    updateAuthUI(null, false);
                    return;
                }
                const data = await resp.json();
                if (!data.ok) {
                    updateAuthUI(null, false);
                    return;
                }
                updateAuthUI(data.user, data.is_admin);
            } catch (e) {
                updateAuthUI(null, false);
            }
        }

        async function analyzeMatch() {
            const vacancy = document.getElementById('vacancy-input').value.trim();
            const resume = document.getElementById('resume-input').value.trim();
            const btn = document.getElementById('analyze-btn');
            const errorMsg = document.getElementById('error-msg');
            const loadingSection = document.getElementById('loading-section');
            const resultsSection = document.getElementById('results-section');

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!vacancy || !resume) {
                errorMsg.textContent = '–ó–∞–ø–æ–ª–Ω–∏ –æ–±–∞ –ø–æ–ª—è ‚Äî –∏ –≤–∞–∫–∞–Ω—Å–∏—é, –∏ —Ä–µ–∑—é–º–µ';
                errorMsg.classList.remove('hidden');
                return;
            }

            if (vacancy.length < 100 || resume.length < 100) {
                errorMsg.textContent = '–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –í—Å—Ç–∞–≤—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ —Ä–µ–∑—é–º–µ.';
                errorMsg.classList.remove('hidden');
                return;
            }

            errorMsg.classList.add('hidden');
            btn.disabled = true;
            btn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';
            resultsSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');

            try {
                // TODO: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π endpoint
                const token = getToken();
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ vacancy, resume })
                });

                if (response.status === 401) {
                    throw new Error('–ù—É–∂–µ–Ω –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram. –û—Ç–∫—Ä–æ–π ¬´–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç¬ª.');
                }
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.');
                }

                const analysis = await response.json();
                displayResults(analysis);

            } catch (error) {
                console.error(error);
                errorMsg.textContent = '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
                errorMsg.classList.remove('hidden');
            }

            btn.disabled = false;
            btn.textContent = '–°—Ä–∞–≤–Ω–∏—Ç—å ‚Üí';
            loadingSection.classList.add('hidden');
        }

        function displayResults(analysis) {
            const resultsSection = document.getElementById('results-section');
            const analysisContent = document.getElementById('analysis-content');
            
            // Count statuses
            const matches = analysis.requirements.filter(r => r.status === 'match').length;
            const partials = analysis.requirements.filter(r => r.status === 'partial').length;
            const gaps = analysis.requirements.filter(r => r.status === 'gap').length;

            document.getElementById('match-count').textContent = matches;
            document.getElementById('partial-count').textContent = partials;
            document.getElementById('gap-count').textContent = gaps;

            // Build HTML
            let html = '';

            // Summary
            html += `
                <div class="bg-[#FFFEF9] border-2 border-black rounded-xl p-4 mb-6">
                    <div class="font-bold mb-2">üìä –†–µ–∑—é–º–µ</div>
                    <p>${analysis.summary}</p>
                </div>
            `;

            // Requirements table
            html += `<div class="font-bold text-lg mb-4">–ú–∞—Ç—Ä–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</div>`;
            html += `<div class="space-y-4 mb-8">`;
            
            analysis.requirements.forEach(req => {
                const statusIcon = req.status === 'match' ? '‚úÖ' : req.status === 'partial' ? 'üü°' : '‚ùå';
                const bgColor = req.status === 'match' ? 'bg-green-50' : req.status === 'partial' ? 'bg-yellow-50' : 'bg-red-50';
                
                html += `
                    <div class="${bgColor} border-2 border-black rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <span class="text-xl">${statusIcon}</span>
                            <div class="flex-1">
                                <div class="font-bold">${req.requirement}</div>
                                ${req.found_in_resume ? `<div class="text-sm text-gray-600 mt-1">–í —Ä–µ–∑—é–º–µ: ${req.found_in_resume}</div>` : ''}
                                <div class="text-sm mt-2 ${req.status === 'match' ? 'text-green-700' : req.status === 'partial' ? 'text-yellow-700' : 'text-red-700'}">
                                    üí° ${req.recommendation}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            // Quick wins
            html += `
                <div class="bg-[#FCD34D] border-2 border-black rounded-xl p-6">
                    <div class="font-bold text-lg mb-4">‚ö° Quick Wins ‚Äî —Å–¥–µ–ª–∞–π –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å</div>
                    <ol class="space-y-2">
                        ${analysis.quick_wins.map((win, i) => `
                            <li class="flex gap-3">
                                <span class="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">${i + 1}</span>
                                <span>${win}</span>
                            </li>
                        `).join('')}
                    </ol>
                </div>
            `;

            analysisContent.innerHTML = html;
            resultsSection.classList.remove('hidden');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        bootAuth();
    </script>

</body>
</html>
